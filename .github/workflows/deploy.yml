name: Deploy to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy (dev or prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  AZURE_SUBSCRIPTION_ID: 5684e867-a54a-43a3-b185-55f48ba6ee24
  AZURE_RESOURCE_GROUP: hr-chatbot-rg
  ACR_NAME: hrchatbotregistry
  ACR_LOGIN_SERVER: hrchatbotregistry.azurecr.io

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
    steps:
      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: determine-environment
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Login to Azure Container Registry
        run: |
          az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/leadops-backend:${{ needs.determine-environment.outputs.environment }}-latest
            ${{ env.ACR_LOGIN_SERVER }}/leadops-backend:${{ needs.determine-environment.outputs.environment }}-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.ACR_LOGIN_SERVER }}/leadops-backend:${{ needs.determine-environment.outputs.environment }}-latest
          cache-to: type=inline

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/leadops-frontend:${{ needs.determine-environment.outputs.environment }}-latest
            ${{ env.ACR_LOGIN_SERVER }}/leadops-frontend:${{ needs.determine-environment.outputs.environment }}-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.ACR_LOGIN_SERVER }}/leadops-frontend:${{ needs.determine-environment.outputs.environment }}-latest
          cache-to: type=inline

  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [determine-environment, build-and-push]
    permissions:
      contents: read
      id-token: write
    environment: ${{ needs.determine-environment.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Bicep template
        id: deploy
        run: |
          DEPLOYMENT_NAME="leadops-${{ needs.determine-environment.outputs.environment }}-$(date +%Y%m%d-%H%M%S)"

          az deployment group create \
            --name "$DEPLOYMENT_NAME" \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file infra/main.bicep \
            --parameters infra/parameters.${{ needs.determine-environment.outputs.environment }}.json \
            --parameters backendImageTag=${{ needs.determine-environment.outputs.environment }}-${{ github.sha }} \
            --parameters frontendImageTag=${{ needs.determine-environment.outputs.environment }}-${{ github.sha }} \
            --query 'properties.outputs' \
            --output json > deployment-outputs.json

          echo "Deployment outputs:"
          cat deployment-outputs.json

          # Extract outputs
          BACKEND_URL=$(jq -r '.backendUrl.value' deployment-outputs.json)
          FRONTEND_URL=$(jq -r '.frontendUrl.value' deployment-outputs.json)

          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT

      - name: Grant ACR pull permissions
        run: |
          # Get backend app principal ID
          BACKEND_APP_NAME="leadops-backend-${{ needs.determine-environment.outputs.environment }}"
          BACKEND_PRINCIPAL_ID=$(az containerapp show \
            --name "$BACKEND_APP_NAME" \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query 'identity.principalId' \
            --output tsv)

          # Get frontend app principal ID
          FRONTEND_APP_NAME="leadops-frontend-${{ needs.determine-environment.outputs.environment }}"
          FRONTEND_PRINCIPAL_ID=$(az containerapp show \
            --name "$FRONTEND_APP_NAME" \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query 'identity.principalId' \
            --output tsv)

          # Get ACR resource ID
          ACR_ID=$(az acr show --name ${{ env.ACR_NAME }} --query id --output tsv)

          # Assign AcrPull role to backend
          az role assignment create \
            --assignee "$BACKEND_PRINCIPAL_ID" \
            --role "AcrPull" \
            --scope "$ACR_ID" || echo "Backend role assignment may already exist"

          # Assign AcrPull role to frontend
          az role assignment create \
            --assignee "$FRONTEND_PRINCIPAL_ID" \
            --role "AcrPull" \
            --scope "$ACR_ID" || echo "Frontend role assignment may already exist"

      - name: Run database migrations
        run: |
          BACKEND_APP_NAME="leadops-backend-${{ needs.determine-environment.outputs.environment }}"

          # Wait for container to be ready
          sleep 30

          # Run migrations
          az containerapp exec \
            --name "$BACKEND_APP_NAME" \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --command "/bin/bash" \
            --args "-c 'cd /app && alembic upgrade head'" || {
              echo "Warning: Migration command failed or container exec not available"
              echo "You may need to run migrations manually"
            }

      - name: Deployment summary
        run: |
          echo "### Deployment Complete :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Backend URL:** ${{ steps.deploy.outputs.backend_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** ${{ steps.deploy.outputs.frontend_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Git SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
